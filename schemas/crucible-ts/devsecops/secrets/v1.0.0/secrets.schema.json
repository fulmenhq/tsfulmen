{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.fulmen.dev/devsecops/secrets/v1.0.0/secrets.schema.json",
  "title": "DevSecOps Project Secrets Schema",
  "description": "Schema for project-scoped secrets files supporting plaintext and encrypted modes with environment variable injection patterns. Used by fulmen-secrets (fulsecrets) CLI tool and DevSecOps microtools.",
  "type": "object",
  "required": [
    "schema_version"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Schema version for compatibility and migration tracking",
      "const": "v1.0.0"
    },
    "projects": {
      "type": "array",
      "description": "Array of project configurations with secrets (plaintext mode only - mutually exclusive with ciphertext)",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/ProjectConfig"
      }
    },
    "encryption": {
      "$ref": "#/$defs/EncryptionMetadata",
      "description": "Encryption metadata (present when file is encrypted)"
    },
    "ciphertext": {
      "type": "string",
      "description": "Encrypted payload containing projects array (encrypted mode only - mutually exclusive with projects). Base64-encoded or PGP-armored format depending on encryption method.",
      "minLength": 1
    },
    "policies": {
      "$ref": "#/$defs/PolicyConfig",
      "description": "Policy enforcement configuration"
    }
  },
  "oneOf": [
    {
      "description": "Plaintext mode: projects array is present, no encryption/ciphertext",
      "required": [
        "projects"
      ],
      "not": {
        "anyOf": [
          {
            "required": [
              "encryption"
            ]
          },
          {
            "required": [
              "ciphertext"
            ]
          }
        ]
      }
    },
    {
      "description": "Encrypted mode: encryption metadata and ciphertext are present, no projects array",
      "required": [
        "encryption",
        "ciphertext"
      ],
      "not": {
        "required": [
          "projects"
        ]
      }
    }
  ],
  "$defs": {
    "ProjectConfig": {
      "type": "object",
      "description": "Configuration for a single project including slug, secrets, and optional env prefix",
      "required": [
        "project_slug",
        "secrets"
      ],
      "properties": {
        "project_slug": {
          "type": "string",
          "description": "Slugified project identifier (lowercase alphanumeric + hyphens, used for filtering in CLI). Examples: 'myapp-prod', 'api-staging', 'worker-dev'",
          "pattern": "^[a-z0-9]+(-[a-z0-9]+)*$",
          "minLength": 1,
          "maxLength": 64
        },
        "env_prefix": {
          "type": "string",
          "description": "Optional prefix for all environment variables in this project. Example: 'APP_' results in APP_DATABASE_URL, APP_API_KEY, etc.",
          "pattern": "^[A-Z_][A-Z0-9_]*$",
          "maxLength": 32
        },
        "secrets": {
          "type": "object",
          "description": "Key-value map of secret names to values. Keys are environment variable names (UPPER_SNAKE_CASE), values are secret strings (no nested objects in v1.0.0).",
          "minProperties": 1,
          "additionalProperties": {
            "type": "string",
            "description": "Secret value as a flat string. No nested structures, complex objects, or reference-based entries in v1.0.0 (deferred to v1.1.0).",
            "minLength": 1
          },
          "propertyNames": {
            "pattern": "^[A-Z_][A-Z0-9_]*$",
            "description": "Environment variable names must be UPPER_SNAKE_CASE"
          }
        }
      },
      "additionalProperties": false
    },
    "EncryptionMetadata": {
      "type": "object",
      "description": "Metadata tracking encryption method, key, and timestamp for roundtrip plaintext â†” ciphertext operations",
      "required": [
        "method",
        "encrypted_at"
      ],
      "properties": {
        "method": {
          "type": "string",
          "description": "Encryption method used for ciphertext",
          "enum": [
            "gpg",
            "age",
            "passphrase"
          ],
          "examples": [
            "gpg",
            "age",
            "passphrase"
          ]
        },
        "key_id": {
          "type": "string",
          "description": "Key identifier for decryption. For GPG: key fingerprint (e.g., '7A8B9C0D1E2F3A4B'). For age: public key (e.g., 'age1ql3z...'). Omit for passphrase-based encryption.",
          "minLength": 1,
          "maxLength": 256
        },
        "encrypted_at": {
          "type": "string",
          "description": "ISO 8601 timestamp when encryption was performed",
          "format": "date-time",
          "examples": [
            "2025-11-15T10:00:00Z",
            "2025-11-15T14:30:00-05:00"
          ]
        },
        "cipher": {
          "type": "string",
          "description": "Cipher algorithm used (e.g., 'AES-256-GCM', 'ChaCha20-Poly1305'). Optional but recommended for auditability.",
          "maxLength": 64,
          "examples": [
            "AES-256-GCM",
            "ChaCha20-Poly1305"
          ]
        }
      },
      "additionalProperties": false
    },
    "PolicyConfig": {
      "type": "object",
      "description": "Policy enforcement configuration for secrets files",
      "properties": {
        "allow_plain_secrets": {
          "type": "boolean",
          "description": "Whether to allow plaintext (unencrypted) secrets files. Set to false for production/compliance environments to enforce encryption ('FIPS mode'). Defaults to true.",
          "default": true
        }
      },
      "additionalProperties": false
    }
  },
  "examples": [
    {
      "$comment": "Example 1: Plaintext mode with single project",
      "schema_version": "v1.0.0",
      "projects": [
        {
          "project_slug": "myapp-dev",
          "env_prefix": "APP_",
          "secrets": {
            "DATABASE_URL": "postgres://localhost:5432/myapp_dev",
            "API_KEY": "dev_key_12345",
            "SECRET_TOKEN": "dev_secret_abc"
          }
        }
      ],
      "policies": {
        "allow_plain_secrets": true
      }
    },
    {
      "$comment": "Example 2: Plaintext mode with multiple projects",
      "schema_version": "v1.0.0",
      "projects": [
        {
          "project_slug": "api-staging",
          "secrets": {
            "DATABASE_URL": "postgres://staging.example.com:5432/api",
            "REDIS_URL": "redis://staging.example.com:6379",
            "API_KEY": "sk_staging_xyz789"
          }
        },
        {
          "project_slug": "worker-staging",
          "secrets": {
            "DATABASE_URL": "postgres://staging.example.com:5432/api",
            "QUEUE_URL": "amqp://staging.example.com:5672",
            "WORKER_TOKEN": "worker_staging_token"
          }
        }
      ]
    },
    {
      "$comment": "Example 3: Encrypted mode with GPG",
      "schema_version": "v1.0.0",
      "encryption": {
        "method": "gpg",
        "key_id": "7A8B9C0D1E2F3A4B",
        "encrypted_at": "2025-11-15T10:00:00Z",
        "cipher": "AES-256-GCM"
      },
      "ciphertext": "-----BEGIN PGP MESSAGE-----\nhQIMA3xQvBF2g8NSAQ//ZQWJ...[truncated for example]\n-----END PGP MESSAGE-----"
    },
    {
      "$comment": "Example 4: Encrypted mode with age",
      "schema_version": "v1.0.0",
      "encryption": {
        "method": "age",
        "key_id": "age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p",
        "encrypted_at": "2025-11-15T14:30:00-05:00",
        "cipher": "ChaCha20-Poly1305"
      },
      "ciphertext": "YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBE...[base64 encoded]"
    },
    {
      "$comment": "Example 5: Production file with encryption enforcement policy",
      "schema_version": "v1.0.0",
      "encryption": {
        "method": "gpg",
        "key_id": "PROD123ABC456DEF",
        "encrypted_at": "2025-11-15T12:00:00Z"
      },
      "ciphertext": "-----BEGIN PGP MESSAGE-----\n...[encrypted projects array]...\n-----END PGP MESSAGE-----",
      "policies": {
        "allow_plain_secrets": false
      }
    }
  ]
}
