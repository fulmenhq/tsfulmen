# TSFulmen - AI Agent Guide

## Read First

1. Check `AGENTS.local.md` if it exists (gitignored)
2. Read `MAINTAINERS.md` for contacts and governance
3. Review `REPOSITORY_SAFETY_PROTOCOLS.md` before executing sync, release, or destructive commands
4. Understand project scope before making changes

## Operating Model

| Aspect         | Setting                                  |
| -------------- | ---------------------------------------- |
| Mode           | Supervised (human reviews before commit) |
| Classification | code-substantive                         |
| Role Required  | Yes                                      |

See [AI Agents Standard](docs/crucible-ts/standards/ai-agents.md) for operating modes and identity scheme.

## Roles

TSFulmen uses Crucible role prompts synced from SSOT. See `.crucible/metadata/metadata.yaml` for current version.

| Role       | Prompt                                                          | Use When                        |
| ---------- | --------------------------------------------------------------- | ------------------------------- |
| `devlead`  | [devlead.yaml](config/crucible-ts/agentic/roles/devlead.yaml)   | Implementation, features, fixes |
| `devrev`   | [devrev.yaml](config/crucible-ts/agentic/roles/devrev.yaml)     | Code review, four-eyes audit    |
| `infoarch` | [infoarch.yaml](config/crucible-ts/agentic/roles/infoarch.yaml) | Documentation, schemas          |
| `entarch`  | [entarch.yaml](config/crucible-ts/agentic/roles/entarch.yaml)   | Ecosystem coordination, parity  |
| `secrev`   | [secrev.yaml](config/crucible-ts/agentic/roles/secrev.yaml)     | Security review                 |

See [Role Catalog](config/crucible-ts/agentic/roles/README.md) for full definitions.

## Project Overview

**tsfulmen** is the TypeScript implementation of the Fulmen helper library ecosystem. It provides:

- Progressive logging (SIMPLE -> STRUCTURED -> ENTERPRISE profiles)
- Enterprise telemetry with MetricRegistry and OTLP export
- FulHash for fast, consistent hashing (xxh3-128, sha256)
- Fulpack archive operations with security-by-default
- Crucible shim for schemas, docs, and config defaults
- Config path utilities (XDG-compliant)
- Application identity and signal handling
- Schema validation with JSON Schema 2020-12

Built on patterns established by [gofulmen](https://github.com/fulmenhq/gofulmen) and coordinated with [pyfulmen](https://github.com/fulmenhq/pyfulmen) and [rsfulmen](https://github.com/fulmenhq/rsfulmen).

## Known Interface Adapters

| Agentic Interface | Definition Prompt / Rules File                       | Attribution Format                                                      |
| ----------------- | ---------------------------------------------------- | ----------------------------------------------------------------------- |
| Codex CLI         | `AGENTS.md`                                          | `Generated by <model> via <interface> under supervision of @3leapsdave` |
| Claude Code       | `CLAUDE.md` (if present) or `AGENTS.md`              | `Generated by <model> via <interface> under supervision of @3leapsdave` |
| Cursor            | `AGENTS.md`                                          | `Generated by <model> via <interface> under supervision of @3leapsdave` |
| Cline             | `.cline/rules/PROJECT.md` (must reference this file) | `Generated by <model> via <interface> under supervision of @3leapsdave` |
| KiloCode          | `AGENTS.md`                                          | `Generated by <model> via <interface> under supervision of @3leapsdave` |
| OpenCode          | `AGENTS.md`                                          | `Generated by <model> via <interface> under supervision of @3leapsdave` |

Replace `<model>` with the canonical model name (e.g., `Claude Opus 4.5`, `GPT-5.2`) and `<interface>` with the agentic tool name (e.g., `OpenCode`, `Claude Code`).

## Quick Reference

| Task           | Command          |
| -------------- | ---------------- |
| Bootstrap      | `make bootstrap` |
| Quality checks | `make check-all` |
| Tests          | `make test`      |
| Build          | `make build`     |
| Format         | `make fmt`       |
| Lint           | `make lint`      |
| TypeCheck      | `make typecheck` |
| Sync Crucible  | `make sync-ssot` |

## Session Protocol

### Before Changes

- Read relevant code first
- Understand the scope
- Keep changes minimal and focused
- Run `make sync-ssot` if Crucible assets may have changed

### Before Committing

- Run `make check-all` (runs fmt, lint, typecheck, test)
- Verify all tests pass
- Use proper attribution (see below)
- Include `Committer-of-Record` trailer

## Commit Attribution

Follow [Agentic Attribution Standard](docs/crucible-ts/standards/agentic-attribution.md):

```
<type>(<scope>): <subject>

<body>

Changes:
- <change 1>
- <change 2>

Generated by <Model> via <Interface> under supervision of @<maintainer>

Co-Authored-By: <Model> <noreply@3leaps.net>
Role: <role>
Committer-of-Record: <Name> <email> [@handle]
```

**Example:**

```
feat(telemetry): add HTTP server metrics middleware

Adds type-safe HTTP instrumentation with automatic route normalization.

Changes:
- Add recordHttpRequest() for manual instrumentation
- Add createHttpMetricsMiddleware() for Express/Fastify
- Add trackActiveRequest() gauge for concurrent connections
- Add tests for route normalization and cardinality protection

Generated by Claude Opus 4.5 via Claude Code under supervision of @3leapsdave

Co-Authored-By: Claude Opus 4.5 <noreply@3leaps.net>
Role: devlead
Committer-of-Record: Dave Thompson <dave.thompson@3leaps.net> [@3leapsdave]
```

**Key requirements:**

- Use `noreply@3leaps.net` for Co-Authored-By (NOT vendor email)
- Include `Role:` trailer matching your operating role
- Include `Committer-of-Record:` with full name, email, and handle

## DO / DO NOT

### DO

- Run `make check-all` before commits
- Read files before editing
- Keep changes focused
- Follow TypeScript idioms and best practices
- Use `bun run` or `bunx` for script execution (never bare `node`/`npm`/`npx`)
- Maintain API consistency with gofulmen where appropriate
- Document public APIs with TSDoc comments

### DO NOT

- Push without maintainer approval
- Skip quality gates
- Commit secrets or API keys
- Touch code outside task scope
- Edit synced files in `config/crucible-ts/`, `schemas/crucible-ts/`, `docs/crucible-ts/`, `src/crucible/`
- Break API compatibility without discussion
- Use bare `node`, `npm`, or `npx` commands (use `bun run` or `bunx`)
- Commit `.plans/` files (gitignored for local planning)

## Key Files

| File                         | Purpose                            |
| ---------------------------- | ---------------------------------- |
| `src/`                       | Main package source                |
| `src/logging/`               | Progressive logging module         |
| `src/telemetry/`             | Enterprise telemetry               |
| `src/fulhash/`               | Fast, consistent hashing           |
| `src/fulpack/`               | Archive operations                 |
| `src/crucible/`              | Crucible shim                      |
| `config/crucible-ts/`        | Synced config from Crucible (SSOT) |
| `schemas/crucible-ts/`       | Synced schemas from Crucible       |
| `docs/crucible-ts/`          | Synced docs from Crucible          |
| `.goneat/ssot-consumer.yaml` | Crucible sync configuration        |

## Synced Assets

Files in these directories are **synced from Crucible SSOT** via `make sync-ssot`:

- `config/crucible-ts/`
- `schemas/crucible-ts/`
- `docs/crucible-ts/`
- `src/crucible/`

**DO NOT edit these files directly.** If changes are needed:

1. Create `.plans/crucible/<YYYYMMDD>/` directory
2. Document proposed changes there for Crucible team review
3. Reset synced files: `git checkout -- config/crucible-ts schemas/crucible-ts docs/crucible-ts src/crucible`
4. After Crucible updates, run `make sync-ssot`

## Standards Reference

- **Online**: https://crucible.3leaps.dev/
- **Full Spec**: https://github.com/fulmenhq/crucible (enterprise-grade)
- **Local synced** (run `make sync-ssot` to update):
  - [AI Agents Standard](docs/crucible-ts/standards/ai-agents.md)
  - [Agentic Attribution Standard](docs/crucible-ts/standards/agentic-attribution.md)
  - [Role Catalog](config/crucible-ts/agentic/roles/README.md)
  - [TypeScript Coding Standards](docs/crucible-ts/standards/coding/typescript.md)
