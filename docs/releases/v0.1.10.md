# TSFulmen v0.1.10 Release Notes

**Release Date:** November 17, 2025
**Release Type:** Critical Bugfix
**Status:** ✅ Released

## Summary

TSFulmen v0.1.10 is a critical bugfix release that resolves catalog loading failures in npm-installed packages from v0.1.9. This release fixes the path resolution bug in the signals catalog loader and adds comprehensive pre-publish verification to prevent similar issues in the future.

## Critical Bug Fixed

### Signal Catalog Loading Failure in Installed Packages

**Problem**: v0.1.9 published successfully to npm but signal catalog loading failed when the package was installed with:

```
FoundryCatalogError: Catalog signals not found or could not be loaded
```

**Root Cause**: The signals catalog loader at `src/foundry/signals/catalog.ts` used path `../../../config/crucible-ts/library/foundry/signals.yaml` which was correct for the source file location. However, when tsup bundled the code into `dist/foundry/index.js`, this path became incorrect - it pointed one level above the package root instead of to `config/` within the package.

**Impact**: All foundry catalog operations (signals, patterns, HTTP statuses, etc.) failed in the installed package, rendering v0.1.9 completely unusable.

## Solution

### Runtime Path Detection

Added intelligent path resolution that detects the execution context and adjusts paths accordingly:

**Implementation** (src/foundry/signals/catalog.ts:20-34):

```typescript
function getConfigPath(): string {
  if (__dirname.includes("/dist/")) {
    // Bundled in dist/foundry/index.js
    return join(
      __dirname,
      "../../config/crucible-ts/library/foundry/signals.yaml",
    );
  }
  // Running from source in src/foundry/signals/
  return join(
    __dirname,
    "../../../config/crucible-ts/library/foundry/signals.yaml",
  );
}
```

**Benefits**:

- Zero runtime overhead
- Works in both development (source) and production (bundled) contexts
- No build-time transformations required
- Maintains clean separation between environments

### Pre-Publish Verification

Added comprehensive pre-publish integration test to catch path resolution bugs before publishing:

**Script**: scripts/verify-local-install.ts

**Process**:

1. Packs package locally using `npm pack`
2. Installs tarball to temporary directory
3. Imports and tests catalog loading in installed context
4. Validates all critical runtime functionality
5. Cleans up temporary files

**Makefile Target**:

```bash
make verify-local-install
```

**Output**:

```
✅ Signal catalog: 8 signals, 6 behaviors
✅ Pattern catalog: 21 patterns loaded
✅ Catalog version: v1.0.0
✅ SIGTERM lookup: ID term
✅ Path resolution: Working correctly in installed package
```

## Changes

### Fixed

- **Signal catalog path resolution** - Added runtime detection to handle both development and production contexts
- **Path resolution in bundled output** - Correctly resolves `config/` directory from `dist/foundry/index.js`

### Added

- **Pre-publish integration test** - New script `scripts/verify-local-install.ts` for local install verification
- **Makefile target** - `make verify-local-install` for pre-publish testing
- **Publishing workflow update** - Added step 3.5 to docs/publishing.md for local install verification
- **Runtime path detection** - Smart path resolution in signals catalog loader

### Changed

- **Signals catalog loader** - Now detects execution context and adjusts paths dynamically

### Documentation

- Updated docs/publishing.md with new verification step
- Added comprehensive comments explaining the path resolution logic
- Documented v0.1.9 deprecation in CHANGELOG.md and RELEASE_NOTES.md
- Added deprecation notice to docs/releases/v0.1.9.md

## Testing

### Quality Gates

All quality gates passing:

- ✅ Lint checks (Biome + goneat)
- ✅ TypeScript type checking
- ✅ Full test suite (1638 tests, 100% pass rate)
- ✅ Build artifacts verification
- ✅ Pre-publish local install verification

### Verification Results

**Local Install Test**:

```bash
make verify-local-install
```

Results:

- Signal catalog: 8 signals, 6 behaviors loaded successfully
- Pattern catalog: 21 patterns loaded successfully
- Catalog version: v1.0.0 verified
- SIGTERM lookup: Working correctly (ID: term)
- Path resolution: Verified in installed package context

**Development Mode**: ✅ Works correctly (running from source)
**Production Mode**: ✅ Works correctly (running from dist/)

## Breaking Changes

None. This is a pure bugfix that restores intended functionality.

## Migration Guide

### From v0.1.9

No code changes required. Simply upgrade:

```bash
npm install @fulmenhq/tsfulmen@latest
```

The package will now work correctly in installed contexts.

## Lessons Learned

### Test Gap Identified

**Gap**: Pre-publish verification only checked tarball contents, not runtime functionality.

**What We Missed**:

- ✅ Tarball contains all config files (verified)
- ✅ Package.json exports correct (verified)
- ✅ Build artifacts present (verified)
- ❌ Runtime path resolution in installed package (NOT tested until post-publish)

**Fix**: Added `make verify-local-install` that tests the actual runtime behavior by installing the package locally and exercising catalog loading.

### Why It Happened

The bundler (tsup) combines multiple source files into single output files. The `__dirname` variable in bundled code points to the bundled file location, not the original source location. Static relative paths that work in source fail in bundled output.

### Prevention

1. **Pre-publish integration test** now catches this class of bug
2. **Runtime path detection** makes code resilient to bundling
3. **Updated release checklist** ensures verification step is not skipped

## Deprecation Notice

**v0.1.9 has been deprecated on npm** with the following message:

```
Non-functional: catalog loading broken. Use 0.1.10+
```

Users should upgrade to v0.1.10 immediately. The v0.1.9 package remains published for transparency but should not be used.

## Stats

- **Lines changed**: +292, -8 (7 files)
- **New files**: 1 (scripts/verify-local-install.ts)
- **Tests**: 1638 passing (100%)
- **Test coverage**: Maintained
- **Release type**: Patch (bugfix)

## Links

- **CHANGELOG**: [CHANGELOG.md](../../CHANGELOG.md)
- **v0.1.9 Release Notes**: [v0.1.9.md](./v0.1.9.md) (deprecated)
- **Publishing Guide**: [docs/publishing.md](../publishing.md)
- **npm Package**: [@fulmenhq/tsfulmen](https://www.npmjs.com/package/@fulmenhq/tsfulmen)
