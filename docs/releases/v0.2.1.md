# TSFulmen v0.2.1 Release Notes

**Release Date**: 2026-01-27
**Release Type**: Feature + Schema Infrastructure
**Crucible Version**: v0.4.9

## Overview

TSFulmen v0.2.1 extends schema validation to support all major JSON Schema drafts (draft-04 through draft-2020-12) with proper meta-validation against declared dialects. This release also introduces the fulencode module as the canonical encoding/decoding facade for binary and text formats.

## Highlights

- **Lifecycle Phase: Beta** - Project graduates from `alpha` to `beta` per Repository Lifecycle Standard (71% line coverage, feature-complete modules, documentation current)
- **Schema Multi-Dialect Support** - Meta-validation and compilation for draft-04, draft-06, draft-07, draft-2019-09, and draft-2020-12
- **Improved validateSchema()** - Now validates schemas against their declared `$schema` dialect, not just AJV compilation success
- **Fulencode Module** - Canonical `fulencode.encode()` / `fulencode.decode()` interface for base64, hex, base32, and text encodings
- **Crucible v0.4.9** - Bundled metaschemas and vocabulary schemas for offline dialect validation

## Breaking Changes

**None** - This release is fully backward compatible.

## Lifecycle Transition

Project graduates from `alpha` to `beta` per the [Repository Lifecycle Standard](../crucible-ts/standards/repository-lifecycle.md):

| Criterion       | Requirement | TSFulmen |
| --------------- | ----------- | -------- |
| Test Coverage   | ≥60%        | 71%      |
| Feature State   | Complete    | ✓        |
| Documentation   | Current     | ✓        |
| Critical Bugs   | Addressed   | ✓        |

**What this means for users:**
- APIs are stabilizing; breaking changes will include migration guidance
- Documentation is comprehensive and maintained
- Critical bugs addressed promptly
- Ready for production evaluation

## New Features

### Schema: Multi-Dialect Validation

Schema meta-validation and compilation now supports all major JSON Schema drafts:

| Draft         | Support Level | AJV Version  |
| ------------- | ------------- | ------------ |
| draft-04      | Full          | ajv-draft-04 |
| draft-06      | Full          | ajv (core)   |
| draft-07      | Full          | ajv (core)   |
| draft-2019-09 | Full          | ajv/2019     |
| draft-2020-12 | Full          | ajv/2020     |

**Key improvements:**

- **Dialect auto-detection**: Reads `$schema` field to determine appropriate validation rules
- **Two-phase validation**: Meta-validation against declared dialect, then compilation check for reference resolution
- **Per-dialect AJV instances**: Cached instances with appropriate metaschemas loaded from Crucible v0.4.9
- **Vocabulary schema loading**: draft-2019-09 and draft-2020-12 vocabulary schemas (core, applicator, validation, meta-data, format, content, unevaluated)

**Usage:**

```typescript
import { validateSchema, compileSchema } from "@fulmenhq/tsfulmen/schema";

// Validates against declared $schema dialect
const result = await validateSchema({
  $schema: "http://json-schema.org/draft-07/schema#",
  type: "object",
  properties: {
    name: { type: "string" },
    age: { type: "integer", minimum: 0 },
  },
  required: ["name"],
});

if (!result.valid) {
  console.error("Schema validation failed:", result.diagnostics);
}

// Compile for data validation
const validator = await compileSchema(schema);
const dataResult = validateData({ name: "Alice", age: 30 }, validator);
```

**Dialect-specific behavior:**

- **draft-04**: Uses `id` instead of `$id` for schema identification
- **draft-06/07**: Standard AJV with format validation
- **draft-2019-09/2020-12**: Full vocabulary support including `unevaluatedProperties` and `unevaluatedItems`

### New Module: Fulencode

New `@fulmenhq/tsfulmen/fulencode` provides a canonical encoding/decoding facade, serving as the standard entry point for all encoding operations in the Fulmen ecosystem.

**Supported Formats:**

| Format       | Type   | Description                    |
| ------------ | ------ | ------------------------------ |
| `base64`     | Binary | Standard Base64 (RFC 4648)     |
| `base64url`  | Binary | URL-safe Base64 (RFC 4648 §5)  |
| `base64_raw` | Binary | Base64 without padding         |
| `hex`        | Binary | Hexadecimal (upper/lower case) |
| `base32`     | Binary | Standard Base32 (RFC 4648)     |
| `base32hex`  | Binary | Extended Hex Base32 (RFC 4648) |
| `utf-8`      | Text   | UTF-8 text encoding            |
| `utf-16le`   | Text   | UTF-16 Little Endian           |
| `utf-16be`   | Text   | UTF-16 Big Endian              |
| `iso-8859-1` | Text   | Latin-1 encoding               |
| `ascii`      | Text   | 7-bit ASCII                    |

**Basic Usage:**

```typescript
import { fulencode } from "@fulmenhq/tsfulmen/fulencode";

// Encode binary data to base64
const encoded = await fulencode.encode(
  new Uint8Array([72, 101, 108, 108, 111]),
  "base64",
);
console.log(encoded.data); // "SGVsbG8="
console.log(encoded.inputSize); // 5
console.log(encoded.outputSize); // 8

// Decode base64 to binary
const decoded = await fulencode.decode("SGVsbG8=", "base64");
console.log(new TextDecoder().decode(decoded.data)); // "Hello"
```

**Encoding Options:**

```typescript
// Hex encoding with uppercase
const hex = await fulencode.encode(data, "hex", { hexCase: "upper" });

// Base64 without padding
const noPad = await fulencode.encode(data, "base64", { padding: false });

// Line wrapping for PEM-style output
const wrapped = await fulencode.encode(data, "base64", {
  lineLength: 64,
  lineEnding: "\n",
});

// With checksum computation
const withChecksum = await fulencode.encode(data, "hex", {
  computeChecksum: "sha256",
});
console.log(withChecksum.checksum); // "sha256:abc123..."
```

**Decoding Options:**

```typescript
// Ignore whitespace in input
const decoded = await fulencode.decode(base64WithNewlines, "base64", {
  ignoreWhitespace: true,
});

// Strict padding validation
const strict = await fulencode.decode(input, "base64", {
  validatePadding: true,
});

// Compute checksum of decoded data
const verified = await fulencode.decode(input, "hex", {
  computeChecksum: "xxh3-128",
});
```

**Error Handling:**

```typescript
import { FulencodeError } from "@fulmenhq/tsfulmen/fulencode";

try {
  await fulencode.decode("invalid!!!", "base64");
} catch (error) {
  if (error instanceof FulencodeError) {
    console.error(`Error code: ${error.code}`);
    console.error(`Operation: ${error.operation}`);
    console.error(`Format: ${error.inputFormat || error.outputFormat}`);
  }
}
```

**Error Codes:**

- `INVALID_INPUT_TYPE` - Wrong input type for format (e.g., string for binary encoding)
- `UNSUPPORTED_FORMAT` - Format not implemented
- `UNSUPPORTED_CHECKSUM` - Checksum algorithm not supported
- `ENCODE_FAILED` / `DECODE_FAILED` - Encoding/decoding operation failed
- `OUTPUT_TOO_LARGE` - Output exceeds size limit

### Packaging

New export path `@fulmenhq/tsfulmen/fulencode` added to package.json exports.

## Crucible SSOT v0.4.9

### Bundled Metaschemas

JSON Schema metaschemas now bundled for offline validation:

```
schemas/crucible-ts/meta/
├── draft-04/
│   └── schema.json
├── draft-06/
│   └── schema.json
├── draft-07/
│   └── schema.json
├── draft-2019-09/
│   ├── schema.json
│   └── meta/
│       ├── core.json
│       ├── applicator.json
│       ├── validation.json
│       ├── meta-data.json
│       ├── format.json
│       └── content.json
└── draft-2020-12/
    ├── schema.json
    └── meta/
        ├── core.json
        ├── applicator.json
        ├── unevaluated.json
        ├── validation.json
        ├── meta-data.json
        ├── format-annotation.json
        └── content.json
```

### Meta Catalog Fixtures

Test fixtures for dialect validation in `config/crucible-ts/meta/`.

## Testing & Quality

### Test Coverage Improvements

Overall line coverage improved from 63.4% to 71.16%:

| Module     | Before | After  | Improvement |
| ---------- | ------ | ------ | ----------- |
| fulencode  | 52.8%  | 99.6%  | +46.8%      |
| fulpack    | 41.7%  | 72.5%  | +30.8%      |
| schema     | 51.2%  | 70.1%  | +18.9%      |
| pathfinder | 77.4%  | 88.3%  | +10.9%      |

**New tests added:**
- Schema dialect tests (`dialects.test.ts`) covering all 5 supported drafts
- Fulencode tests for all binary/text formats and options
- Fulpack archive operation edge cases
- Pathfinder boundary and traversal scenarios

### Quality Gates

- **lint**: Clean
- **typecheck**: Clean
- **validate-all**: Pass

## Migration Guide

### From v0.2.0

No migration required. All changes are additive.

### Schema Validation

If you were relying on `validateSchema()` only checking AJV compilation:

```typescript
// v0.2.0: Only checked if AJV could compile
const result = await validateSchema(schema);

// v0.2.1: Now validates against declared $schema dialect
// This may surface previously-hidden dialect violations
const result = await validateSchema(schema);
if (!result.valid) {
  // Check diagnostics for dialect-specific errors
  console.log(result.diagnostics);
}
```

### Encoding Operations

If you were using raw Buffer/TextEncoder for encodings:

```typescript
// Before
const base64 = Buffer.from(data).toString("base64");

// After (recommended for ecosystem consistency)
import { fulencode } from "@fulmenhq/tsfulmen/fulencode";
const result = await fulencode.encode(data, "base64");
const base64 = result.data;
```

## Dependencies

### Added

- `ajv-draft-04` - AJV adapter for JSON Schema draft-04

### Updated

- Crucible SSOT: v0.4.8 → v0.4.9

## Known Issues

None.

## Contributors

- Dave Thompson (@3leapsdave) - Human maintainer
- Claude Opus 4.5 (devlead role) - AI assistance

---

_This release was generated with AI assistance under human supervision per the Crucible AI Agents Standard v2.0.0._
