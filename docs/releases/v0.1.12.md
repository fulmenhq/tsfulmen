# TSFulmen v0.1.12 Release Notes

**Release Date**: 2025-11-18
**Release Type**: Bug Fix + Quality Infrastructure
**Status**: âœ… Ready for Release

## Summary

Version 0.1.12 fixes a critical packaging bug from v0.1.11 where telemetry submodules were not built, and adds comprehensive package integrity validation to prevent this class of failure from recurring. Also improves HTTP middleware type safety with proper framework types.

## Critical Fix: Telemetry Module Exports

### Problem (v0.1.11)

v0.1.11 was published with release notes documenting `@fulmenhq/tsfulmen/telemetry/http` and `@fulmenhq/tsfulmen/telemetry/prometheus` modules, but these modules were **not included** in the published package:

- Source code existed in `src/telemetry/http/` and `src/telemetry/prometheus/`
- `tsup.config.ts` was missing entries to build these modules
- `package.json` was missing `./telemetry/http` export (prometheus export existed but pointed to non-existent files)
- Build completed successfully but did NOT generate subdirectories
- Downstream consumers (forge-workhorse-tuvan) blocked on telemetry integration

**Impact**: Published package did not match documentation, breaking downstream projects.

### Solution

Fixed build configuration to include all telemetry submodules:

**tsup.config.ts** - Added missing entries:

```typescript
"telemetry/http/index": "src/telemetry/http/index.ts",
"telemetry/prometheus/index": "src/telemetry/prometheus/index.ts",
```

**package.json** - Added missing export:

```json
"./telemetry/http": {
  "import": "./dist/telemetry/http/index.js",
  "types": "./dist/telemetry/http/index.d.ts"
}
```

**Verification**:

- âœ… `dist/telemetry/http/` now built (186KB JS + 9.4KB types)
- âœ… `dist/telemetry/prometheus/` now built (389KB JS + 25KB types)
- âœ… All package exports resolve correctly
- âœ… Consumer imports work: `import { createFastifyMetricsPlugin } from '@fulmenhq/tsfulmen/telemetry/http'`

## New Feature: Package Integrity Validation

### Motivation

The v0.1.11 packaging failure revealed a critical gap: **no automated validation that package.json exports match built artifacts before publish**. This resulted in:

- Incomplete packages published to npm
- Downstream projects blocked
- Manual verification required
- Trust erosion

### Solution: 6-Layer Validation System

Implemented comprehensive pre-publish validation that **fails the build** if package integrity is compromised.

#### Validation Scripts

**1. validate-exports.ts** - Export Path Validation

- Verifies every `package.json` export points to files that exist in `dist/`
- Checks both `import` and `types` paths
- Ensures files are non-empty (> 0 bytes)
- **Would have caught v0.1.11**: Missing `dist/telemetry/http/index.js` and `.d.ts`

**2. validate-tsup-config.ts** - Build Configuration Alignment

- Verifies `tsup.config.ts` entries match `package.json` exports
- Detects missing tsup entries for exported modules
- Reports orphaned tsup entries (built but not exported)
- **Would have caught v0.1.11**: Missing `telemetry/http/index` tsup entry

**3. validate-source-modules.ts** - Source-to-Build Mapping

- Scans `src/` for modules with `index.ts` files
- Detects source modules not configured for build
- Supports `.no-export` marker for intentional internal modules
- Prevents "forgot to export" errors

**4. validate-package-contents.ts** - Package Structure Verification

- Simulates `npm pack` to verify file structure
- Ensures expected directories present (`dist/`, `config/`, `schemas/`)
- Checks for unexpected files (test files, `.plans/`, `node_modules/`)
- Validates both `.js` and `.d.ts` for each module

**5. validate-imports.ts** - Consumer Import Simulation

- Dynamically imports each `package.json` export
- Catches runtime resolution errors
- Verifies modules load without errors
- Tests both CommonJS and ESM imports

**6. validate-types.ts** - Type Declaration Completeness

- Verifies all `.js` files have corresponding `.d.ts` files
- Checks `.d.ts` files are non-empty and valid TypeScript
- Catches tsup type generation failures

#### Integration

**prepublishOnly Hook** - Automatic validation before publish:

```json
"prepublishOnly": "bun run quality && bun run validate:all && bunx tsx scripts/prepare-wasm-package.ts"
```

**Makefile Targets** - Individual and combined validation:

```makefile
make validate-exports         # Validate export paths
make validate-tsup            # Validate tsup configuration
make validate-source-modules  # Validate source mapping
make validate-package         # Validate package contents
make validate-imports         # Validate consumer imports
make validate-types           # Validate type declarations
make validate-all             # Run all validations
```

**Package Scripts** - Developer-friendly access:

```bash
bun run validate:exports
bun run validate:tsup
bun run validate:source-modules
bun run validate:package
bun run validate:imports
bun run validate:types
bun run validate:all
```

#### Validation Output

**Success**:

```
ðŸ” Validating package.json exports...
âœ… Export validation passed
ðŸ” Validating tsup configuration...
âœ… tsup configuration validation passed
ðŸ” Validating source module mapping...
âœ… Source module mapping validation passed
ðŸ” Validating package contents...
âœ… Package contents validation passed
ðŸ” Validating consumer imports...
âœ… Consumer import validation passed
ðŸ” Validating type declarations...
âœ… Type declaration validation passed
âœ… All package integrity validations passed
```

**Failure Example** (reproducing v0.1.11):

```
âŒ Export validation failed:
- ./telemetry/http -> dist/telemetry/http/index.js (NOT FOUND)
- ./telemetry/http -> dist/telemetry/http/index.d.ts (NOT FOUND)
- ./telemetry/prometheus -> dist/telemetry/prometheus/index.js (NOT FOUND)
- ./telemetry/prometheus -> dist/telemetry/prometheus/index.d.ts (NOT FOUND)
```

#### Impact

- **Zero incomplete packages**: Validation prevents `npm publish` if artifacts missing
- **Fast feedback**: All validations complete in < 5 seconds
- **Clear errors**: Specific file paths and actionable error messages
- **CI/CD safe**: Runs automatically before any release
- **Developer friendly**: Individual scripts for targeted debugging

## Enhancement: HTTP Middleware Type Safety

### Problem

HTTP metrics module (`src/telemetry/http/index.ts`) had 13 undocumented `any` type usages across framework integration points, reducing type safety and IDE support for consumers.

### Solution

Added proper TypeScript framework types with optional peer dependencies:

**Optional Peer Dependencies**:

```json
"peerDependencies": {
  "@types/express": "^4.17.0 || ^5.0.0",
  "fastify": "^4.0.0 || ^5.0.0"
},
"peerDependenciesMeta": {
  "@types/express": { "optional": true },
  "fastify": { "optional": true }
}
```

**New Type Module** (`src/telemetry/http/types.ts`):

- `GenericHttpRequest` / `GenericHttpResponse` - Cross-framework interfaces
- `RouteNormalizer` - Type-safe route extraction callback
- `MethodExtractor` - Type-safe method extraction callback
- `StatusExtractor` - Type-safe status extraction callback
- `NextFunction` - Express-style middleware next function

**Type Improvements**:

- Express middleware: `ExpressRequest`, `ExpressResponse`, `NextFunction`
- Fastify plugin: `FastifyInstance`, `FastifyRequest`, `FastifyReply`, `FastifyPluginCallback`
- Bun handler: Native `Request` / `Response` types
- Replaced 13 undocumented `any` types with proper framework types
- Retained 5 justified `any` casts with `biome-ignore` comments for Fastify runtime property injection

### Benefits

- **Full TypeScript autocomplete** for framework request/response objects
- **Compile-time error detection** for type mismatches
- **Self-documenting code** through explicit type signatures
- **Zero runtime changes** - purely compile-time enhancement
- **Optional dependencies** - no forced installs, consumers only need types for frameworks they use

## Version Bump

**v0.1.11 â†’ v0.1.12** (patch)

- Patch bump appropriate for bug fix + infrastructure improvements
- No breaking changes
- No new public API (validation is development-only)
- HTTP typing is additive enhancement (consumers see better autocomplete)

## Testing

**All Tests Passing**: 1749 tests (102 test files)

- âœ… HTTP metrics tests (40+ tests)
- âœ… Package validation integration tests
- âœ… Type safety verified with strict TypeScript checks
- âœ… All quality gates pass (lint, typecheck, validate-all)

## Migration Guide

### From v0.1.11

**If you successfully installed v0.1.11**: You likely didn't use HTTP or Prometheus modules. No changes needed.

**If blocked by missing modules**:

1. Update to v0.1.12: `bun install @fulmenhq/tsfulmen@0.1.12`
2. Verify imports work:
   ```typescript
   import { createFastifyMetricsPlugin } from "@fulmenhq/tsfulmen/telemetry/http";
   import { PrometheusExporter } from "@fulmenhq/tsfulmen/telemetry/prometheus";
   ```
3. No code changes required

**If using HTTP middleware**: Enjoy better autocomplete! No code changes needed.

## Verification Checklist

Before v0.1.12 release:

- [x] All 6 validation scripts implemented and tested
- [x] Validation integrated into `prepublishOnly` hook
- [x] Validation integrated into Makefile
- [x] Build generates `dist/telemetry/http/` and `dist/telemetry/prometheus/`
- [x] All package.json exports resolve correctly
- [x] All tests passing (1749 tests)
- [x] Typecheck clean
- [x] Lint clean
- [x] `make validate-all` passes
- [x] HTTP framework types installed as devDependencies
- [x] Optional peerDependencies configured
- [x] CHANGELOG.md updated
- [x] RELEASE_NOTES.md updated
- [x] This release doc created

## Credits

**Module Weaver** (@module-weaver) - Package integrity validation, build fixes, type safety improvements
**Supervised by**: @3leapsdave
**Generated with**: [Claude Code](https://claude.com/claude-code)

---

**Next Release**: See [RELEASE_NOTES.md](../../RELEASE_NOTES.md) for v0.1.13 planning
