# TSFulmen v0.1.11 Release Notes

**Release Date**: TBD (In Progress)
**Release Type**: New Features
**Status**: ðŸš§ Ready for Release

## Summary

Version 0.1.11 introduces two major features for production observability: HTTP server metrics with Crucible v0.2.18 taxonomy and logging middleware with secure-by-default redaction. These features provide enterprise-grade instrumentation and security controls for TypeScript applications.

## Features

### 1. HTTP Server Metrics (`@fulmenhq/tsfulmen/telemetry/http`)

Implements Crucible v0.2.18 HTTP metrics taxonomy with type-safe helpers for instrumenting HTTP servers. Provides production-ready middleware for Express, Fastify, and Bun with automatic route normalization, unit conversion, and AppIdentity integration.

#### Core Helpers

**recordHttpRequest(options)** - Records all applicable HTTP metrics

- Automatic unit conversion: milliseconds â†’ seconds for duration
- Auto-injects service label from AppIdentity (fallback: "unknown")
- Records up to 4 metrics per request (counter + 3 optional histograms)
- Type-safe labels enforced at compile time

**trackActiveRequest(service?)** - Active requests gauge management

- Returns cleanup function for guaranteed decrement
- Safe for concurrent requests across multiple services
- Integrates with middleware error handling

#### Framework Middleware

1. **createHttpMetricsMiddleware(options)** - Express/Connect
   - Automatic request lifecycle tracking
   - Configurable route normalizer (defaults to req.route?.path || req.path)
   - Optional body size tracking via content-length headers
   - Cleanup on finish/error/close events

2. **createFastifyMetricsPlugin(options)** - Fastify
   - Hook-based instrumentation (onRequest, onResponse, onError)
   - Route template extraction from req.routeOptions.url (Fastify v3+)
   - Request context storage for timing and cleanup

3. **createBunMetricsHandler(handler, options)** - Bun.serve
   - Fetch handler wrapper with metrics
   - Pathname normalization required (no built-in routing)
   - Error-safe cleanup with try/catch

#### Metrics Emitted (Crucible v0.2.18)

| Metric                        | Type      | Unit  | Labels                         |
| ----------------------------- | --------- | ----- | ------------------------------ |
| http_requests_total           | Counter   | count | method, route, status, service |
| http_request_duration_seconds | Histogram | s     | method, route, status, service |
| http_request_size_bytes       | Histogram | bytes | method, route, service         |
| http_response_size_bytes      | Histogram | bytes | method, route, status, service |
| http_active_requests          | Gauge     | count | service                        |

#### Critical Implementation Details

- **Unit Conversion**: Duration auto-converts ms â†’ seconds (123.456ms â†’ 0.123456s)
- **Route Normalization**: Callers must normalize routes to prevent cardinality explosion
  - Use framework templates: `req.route?.path` (Express), `req.routeOptions?.url` (Fastify)
  - Or use Phase 2 `normalizeRoute()` utility: `/users/123` â†’ `/users/:userId`
- **Body Size Tracking**: Disabled by default for performance
  - Only records when `trackBodySizes: true` AND content-length headers present
  - Read from headers, no body parsing overhead

#### Documentation

- **API Reference**: Complete function signatures with TypeScript types
- **Framework Integration**: 4 framework examples (Express, Fastify, Bun, Node.js HTTP)
- **Troubleshooting**: 6 common issues with symptoms/causes/solutions
- **Production Recommendations**: 5 best practices
- **Framework Notes**: Version compatibility, route extraction patterns

#### Testing

- 40+ tests covering all helpers and middleware
- 100% coverage for HTTP helpers module
- Unit conversion accuracy tests (7 precision cases)
- Concurrent request tracking tests
- Middleware lifecycle tests for all frameworks

### 2. Logging Middleware & Secure Redaction (`@fulmenhq/tsfulmen/logging`)

Implements middleware pipeline support for STRUCTURED and ENTERPRISE logging profiles with secure-by-default redaction. Provides gofulmen-aligned patterns for cross-language consistency and a progressive interface from simple structured logging to enterprise-scale observability.

#### Middleware Pipeline Support

**StructuredLogger Middleware** - Pipeline execution before Pino emission

- Middleware chains execute in order (left-to-right)
- Child loggers inherit parent middleware chain
- Child bindings merge (child overrides parent on conflict)
- Middleware can modify event severity (finalSeverity honored)

**Built-in Middleware Classes**:

- `RedactSecretsMiddleware` - Enhanced with gofulmen-aligned defaults
- `AddFieldsMiddleware` - Inject context fields into events
- `TransformMiddleware` - Custom event transformations

#### RedactSecretsMiddleware Enhancements

**Gofulmen-Aligned Patterns** (cross-language consistency):

- `SECRET_[A-Z0-9_]+` - Environment variable secrets
- `[A-Z0-9_]*TOKEN[A-Z0-9_]*`, `[A-Z0-9_]*KEY[A-Z0-9_]*` - Token/key variants
- `[A-Za-z0-9+/]{40,}={0,2}` - Base64 blobs (40+ characters)
- `[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}` - Email addresses
- `\b\d{13,19}\b` - Credit card numbers (13-19 digits)

**Default Field Names** (case-insensitive):

- password, token, apiKey, api_key, authorization, secret
- cardNumber, card_number, cvv, ssn
- accessToken, access_token, refreshToken, refresh_token

**Performance Optimization**:

- 10KB threshold: Pattern scanning skipped for strings >10KB
- Field-based redaction (O(1) lookup) always applies
- Pre-compiled regex patterns at construction
- Case-insensitive map pre-computed for fast field matching

#### Helper Function: createStructuredLoggerWithRedaction()

**Secure-by-Default**: Redaction enabled automatically

**Customization Options**:

- `customPatterns?: RegExp[]` - Add organization patterns
- `customFields?: string[]` - Add application-specific field names
- `useDefaultPatterns?: boolean` - Opt-out of defaults (default: true)
- `filePath?: string` - Optional file output

**Progressive Interface**: Simple â†’ Structured â†’ Structured+Redaction â†’ Enterprise

#### Child Logger Inheritance

- Child loggers inherit parent's middleware chain (exact same pipeline)
- Bindings merge: child bindings override parent on conflict
- Middleware executes identically for parent and child
- Guaranteed security: child of redacting logger always redacts

#### Severity Adjustment

- Middleware can modify event severity via `finalSeverity`
- Use cases: downgrade noisy errors to warnings, upgrade critical info to error
- Honored by Pino logger for final emission

#### Documentation

**Logging README** (src/logging/README.md - 789 lines):

- Complete middleware architecture documentation
- 35+ code examples covering all use cases
- API reference for all middleware classes and helpers
- Troubleshooting guide (4 scenarios with solutions)
- Migration guide (3 paths: simple â†’ structured â†’ secure)
- Performance section with 10KB threshold explanation
- Security model documentation (default-on redaction)
- Progressive interface guide (zero-complexity to enterprise)
- Policy enforcement documentation
- Cross-references to gofulmen and Crucible standards

**Main README Update** (74 lines):

- New "Progressive Logging" section with 3-level progression
- Before/after redaction output examples
- Security model callout (default-on redaction)
- Performance callout (10KB pattern-scan guard)
- Customization examples (custom patterns/fields, opt-out)
- Child logger inheritance documentation

#### Testing (121 total logging tests)

**Phase 3 Integration Tests** (12 new tests):

1. Helper creates logger with redaction middleware
2. Default field names (case-insensitive redaction)
3. Default redaction patterns (SECRET\_, TOKEN, Base64, emails, cards)
4. File output + redaction combination
5. Custom patterns override
6. Custom fields support
7. `useDefaultPatterns: false` disables defaults
8. Child loggers preserve redaction
9. Nested objects with redaction
10. Arrays with redaction
11. Email address redaction
12. Credit card number redaction

**Existing Test Coverage**:

- middleware.test.ts: 35 tests (Phase 1 - enhanced redaction)
- logger.test.ts: 28 tests (Phase 2 - middleware pipeline)
- create-logger.test.ts: 17 tests (5 existing + 12 new)
- policy.test.ts: 36 tests (existing)
- sinks.test.ts: 5 tests (existing)

#### Security Model

**Default-On Redaction**:

- `createStructuredLoggerWithRedaction()` enables redaction by default
- Gofulmen-aligned patterns protect common secrets automatically
- Opt-out available via `useDefaultPatterns: false` for full control

**Performance-Conscious**:

- 10KB threshold skips pattern scanning on large payloads
- Field-based redaction (O(1)) always applies
- Minimal middleware overhead (<5% typical)

**Cross-Language Consistency**:

- Patterns and field names match gofulmen
- Same secrets redacted across TypeScript, Go, Python

## Quality Gates

All quality gates passed for v0.1.11:

- **Tests**: 1749 passing (102 test files)
- **TypeCheck**: Clean
- **Lint**: 35 pre-existing warnings (none from new code)
- **Format**: All files formatted (goneat + biome)
- **Documentation**: Comprehensive with 35+ examples (logging) + detailed HTTP metrics guide
- **Schema Parity**: Verified
- **App Identity Parity**: Verified
- **Signals Catalog Integrity**: Verified

## Breaking Changes

**None** - Both features are additive only and maintain full backward compatibility.

## Migration

**N/A** - Both features are new and opt-in. No migration required for existing code.

## Dependencies

No new external dependencies added in this release.

## Files Modified

### HTTP Server Metrics

- `src/telemetry/http/index.ts` - New module (475 lines)
- `src/telemetry/http/README.md` - Documentation (636 lines)
- `src/telemetry/http/__tests__/index.test.ts` - Tests (769 lines, 40+ tests)
- `src/telemetry/http/__tests__/route-normalizer.test.ts` - Route normalization tests
- `README.md` - HTTP Server Metrics section added

### Logging Middleware & Redaction

- `src/logging/create-logger.ts` - createStructuredLoggerWithRedaction() helper (+72 lines)
- `src/logging/index.ts` - Export new helper (+1 export)
- `src/logging/__tests__/create-logger.test.ts` - Integration tests (+12 tests)
- `src/logging/README.md` - Comprehensive documentation (new file, 789 lines)
- `README.md` - Progressive Logging section (+74 lines)
- `CHANGELOG.md` - Feature documentation

## Upgrade Instructions

### Installing

```bash
npm install @fulmenhq/tsfulmen@^0.1.11
# or
bun add @fulmenhq/tsfulmen@^0.1.11
```

### Using HTTP Server Metrics

```typescript
import { createHttpMetricsMiddleware } from "@fulmenhq/tsfulmen/telemetry/http";

// Express
app.use(
  createHttpMetricsMiddleware({
    serviceName: "api-server",
  }),
);

// Fastify
await fastify.register(createFastifyMetricsPlugin, {
  serviceName: "api-server",
});

// Bun
const wrappedHandler = createBunMetricsHandler(handler, {
  serviceName: "api-server",
});
```

### Using Secure Logging

```typescript
import { createStructuredLoggerWithRedaction } from "@fulmenhq/tsfulmen/logging";

// Secure by default
const logger = createStructuredLoggerWithRedaction("auth-service");

logger.info("User login", {
  userId: "user-123",
  email: "user@example.com", // â† Automatically redacted
  password: "secret123", // â† Automatically redacted
});

// Customize patterns
const customLogger = createStructuredLoggerWithRedaction("api-server", {
  customPatterns: [/INTERNAL_ID_\d+/g],
  customFields: ["internalKey"],
});
```

## Known Issues

None reported at release time.

## Next Steps

- Phase 4 (Additional integration tests) - Optional, comprehensive coverage already achieved
- Phase 6 (Final QA) - In progress
- Release to npm after final approval

---

**Release prepared by**: Module Weaver (@module-weaver)
**Supervised by**: @3leapsdave
**Date**: November 18, 2025
