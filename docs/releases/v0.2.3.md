# Release Notes: v0.2.3

**Release Date**: 2026-02-01
**Release Type**: Security + Infrastructure + Workhorse Features

## Vitest 4.x Upgrade - CVE Remediation

**Summary**: Upgrades vitest test framework from v2.1.9 to v4.0.18, eliminating 70 Go stdlib CVEs in dev/CI toolchain. No changes to shipped library code.

### Security Impact

The vitest 2.x/3.x dependency chain included vite 5.x, which bundled an esbuild binary compiled with Go 1.20.12. This Go version has multiple critical CVEs. Upgrading to vitest 4.x pulls vite 7.x with esbuild compiled on Go 1.25.5.

| Metric    | Before | After | Change  |
| --------- | ------ | ----- | ------- |
| Critical  | 6      | 0     | -6      |
| High      | 34     | 10    | -24     |
| Medium    | 54     | 14    | -40     |
| **Total** | 94     | 24    | **-70** |

**Scope clarification**:

- **Production code surface**: 0 vulnerabilities
- **Dev/CI tooling**: 24 findings (all in esbuild binaries used by vitest/vite)

These vulnerabilities only affected dev/CI tooling (test runner), not the published library.

### Performance

Test suite execution improved by 32% (56s â†’ 38s).

---

## Release Infrastructure: Prepublish Guard

**Fixes**: v0.2.2 npm publish error

**Summary**: Adds comprehensive guards to prevent accidental publishes from dirty working trees or mismatched versions. This prevents the v0.2.2 incident where the publish workflow read local package.json before version bump completed.

### New Safeguards

- **Clean worktree check**: Prevents publishing with uncommitted changes
- **VERSION consistency**: Validates `src/index.ts` VERSION constant matches `package.json`
- **Tag alignment**: Requires HEAD to match the `v<VERSION>` tag before publish
- **Automated enforcement**: Runs in `npm prepublishOnly` lifecycle

### Why v0.2.2 Was Skipped

Version 0.2.2 was consumed by the npm publish workflow reading local `package.json` before the version bump completed. No package was actually published to npm under this version. The new guard ensures version/tag alignment before any publish attempt.

---

## Workhorse Control-Plane Features

**Summary**: New control-plane endpoints and runtime diagnostics for workhorse template integration. These features enable standardized service discovery, configuration management, and observability for Fulmen-based services.

### Control Discovery Endpoint

Standardized discovery payload for control-plane integration:

```typescript
import { createControlDiscoveryEndpoint } from "@fulmenhq/tsfulmen/foundry/signals";

// Create discovery endpoint for load balancers/orchestrators
const discovery = createControlDiscoveryEndpoint({
  serviceName: "api-server",
  version: "1.0.0",
  capabilities: ["health", "metrics", "config"],
});

// Returns structured discovery info with endpoints and health status
console.log(discovery.endpoints); // { health: "/health", metrics: "/metrics", ... }
console.log(discovery.status); // "ready" | "degraded" | "down"
```

### Config Reload Endpoint

HTTP POST handler for live configuration reloading with safety checks:

```typescript
import { createConfigReloadEndpoint } from "@fulmenhq/tsfulmen/foundry/signals";

// Create POST /admin/config/reload handler
const reloadHandler = createConfigReloadEndpoint({
  identity: await loadIdentity(),
  defaultsPath: "./config/defaults.yaml",
  onReload: (newConfig) => {
    console.log("Config reloaded:", newConfig);
    return { success: true };
  },
});

// Use with Fastify/Express/Bun
app.post("/admin/config/reload", reloadHandler);
```

### Runtime Info Helper

Consistent service/runtime metadata for diagnostics:

```typescript
import { buildRuntimeInfo } from "@fulmenhq/tsfulmen/appidentity";

const runtime = buildRuntimeInfo({
  service: "my-service",
  version: "1.2.3",
});

console.log(runtime); // { service, version, uptime, memory, cpu, ... }
```

### Environment Variable Improvements

**Env Alias Resolution**: Map environment variable names to config paths:

```typescript
import { loadConfig } from "@fulmenhq/tsfulmen/config";

const { config, metadata } = await loadConfig<AppConfig>({
  identity,
  defaultsPath: "./defaults.yaml",
  // New: optional env var consumption reporting
  trackEnvVars: true, // Reports which env vars were consumed
});

// metadata.envConsumed shows: ["MYAPP_PORT", "MYAPP_LOG_LEVEL", ...]
```

### AJV Formats Helper

Shared AJV format validators for Fastify integration:

```typescript
import { applyFulmenAjvFormats } from "@fulmenhq/tsfulmen/schema";
import Fastify from "fastify";

const app = Fastify({
  ajv: {
    customOptions: applyFulmenAjvFormats(),
  },
});
// Now supports: uuid, uri, email, date-time formats in schemas
```

See `docs/guides/fastify-ajv-formats.md` for complete Fastify integration guide.

---

## Test Infrastructure Improvements

### CI Timeout Protection

- **Global 30s timeout**: Prevents false-positive test failures during resource-constrained npm prepublish pipeline
- **Discovery thresholds**: Increased from 2s to 5s for Crucible asset discovery (accommodates prepublish resource exhaustion)

### Quality Gates

- Tests: 2097 passing
- Lint: Clean
- TypeCheck: Clean
