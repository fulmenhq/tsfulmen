# Incident Report: v0.2.5 Release Failure

**Date**: 2026-02-03  
**Severity**: Medium (broken release, no user impact - fresh version)  
**Status**: Resolved (v0.2.6)  
**Root Cause**: Process discipline failure - skipped mandatory pre-tag verification

## Summary

Version 0.2.5 was tagged and published to npm without running `make verify-local-install`. The package contained broken ESM imports and test timeout issues, rendering it completely unusable. Version number 0.2.5 was permanently burned (npm doesn't allow republishing). Emergency v0.2.6 release resolved both issues.

## Timeline (UTC)

| Time  | Event                                                              |
| ----- | ------------------------------------------------------------------ |
| 20:31 | Created tag v0.2.5, pushed to GitHub                               |
| 20:34 | CI validation passed                                               |
| 20:57 | Workflow failed: bootstrap (sfetch 403) - manually restarted       |
| 23:00 | Bootstrap succeeded, prepublish failed: test timeout (60s)         |
| 23:04 | Tests passed on retry, **npm publish succeeded** (v0.2.5 live)     |
| 23:05 | Post-verification failed: ESM import error detected                |
| 23:30 | Attempted retag, discovered v0.2.5 already on npm (cannot replace) |
| 00:00 | Fixed ESM imports (commit 86fdb32)                                 |
| 00:15 | Fixed test timeout (commit e006df4)                                |
| 01:00 | Deleted v0.2.5 tag, bumped VERSION to 0.2.6                        |
| 01:30 | **Followed RELEASE_CHECKLIST.md completely** for v0.2.6            |
| 01:38 | v0.2.6 published successfully with all fixes                       |

## Issues Identified

### Issue 1: ESM Import Extensions Missing

**File**: `src/schema/validator.ts`  
**Commit Fix**: 86fdb32

**Problem**: Missing `.js` extensions on ajv subpath imports:

```typescript
import Ajv2019 from "ajv/dist/2019"; // âŒ Broken
import Ajv2020 from "ajv/dist/2020"; // âŒ Broken
```

**Error**:

```
Error [ERR_MODULE_NOT_FOUND]: Cannot find module '/node_modules/ajv/dist/2019'
Did you mean to import "ajv/dist/2019.js"?
```

**Why it worked locally**: TypeScript moduleResolution handles extensionless imports  
**Why it broke in production**: ESM spec requires explicit extensions for subpath imports

**Fix**:

```typescript
import Ajv2019 from "ajv/dist/2019.js"; // âœ… Fixed
import Ajv2020 from "ajv/dist/2020.js"; // âœ… Fixed
```

### Issue 2: Test Timeout in CI

**File**: `src/schema/goneat-bridge.ts`  
**Commit Fix**: e006df4

**Problem**: Spawn promise had no timeout when checking if goneat exists.

**Impact**: Test hung for 60s on 2-core CI runners when goneat not in PATH, blocking prepublish.

**Fix**: Added 5-second timeout to spawn operation.

### Issue 3: Bootstrap 403 Errors (External)

**Component**: sfetch installer  
**Status**: Documented, awaiting sfetch team fix

**Problem**: sfetch install script doesn't use GITHUB_TOKEN for GitHub API requests, causing 403 rate limit errors in CI.

**Memo**: `.plans/memos/sfetch/20260203-install-script-github-token.md`

## Root Cause Analysis

### Immediate Cause

Two code bugs: missing ESM extensions + spawn timeout

### Contributing Factors

1. Skipped `make verify-local-install` before tagging (Step 2 of RELEASE_CHECKLIST.md)
2. Skipped `npm publish --dry-run` before tagging (Step 3)
3. No programmatic enforcement of checklist compliance
4. Agent (releng role) did not emphasize checklist in initial guidance

### Underlying Cause

**Process discipline failure** - Documented checklist exists and works, but was not followed.

## What Prevented Detection

- **Unit tests**: Run from source with bundler resolution, don't catch ESM issues
- **CI tests**: Same issue - use bundler, not real npm install
- **Type checking**: TypeScript accepts extensionless imports
- **Build**: tsup successfully bundles without adding extensions

## What Would Have Prevented It

**Single command**: `make verify-local-install`

This command:

1. Creates npm pack tarball
2. Installs to temp directory (real npm install)
3. Tests imports using Node's ESM loader (not bundler)
4. **Would have immediately failed** with ERR_MODULE_NOT_FOUND

**Time cost**: ~10 seconds  
**Cost of skipping**: Burned version number, emergency release, documentation updates, team time

## Resolution

### Immediate Actions

1. âœ… Fixed ESM imports (commit 86fdb32)
2. âœ… Fixed test timeout (commit e006df4)
3. âœ… Bumped to v0.2.6
4. âœ… **Followed checklist completely** for v0.2.6
5. âœ… Published v0.2.6 successfully

### Short-Term Actions

1. âœ… Updated AGENTS.md with CRITICAL checklist reminder
2. âœ… Updated docs/publishing.md with process warning
3. âœ… Marked v0.2.5 as broken in CHANGELOG.md
4. â³ Deprecate v0.2.5 on npm (awaiting maintainer credentials)
5. â³ Create GitHub release for v0.2.6 (manual, automation had issues)

### Long-Term Actions

1. âœ… Drafted Crucible role prompt updates (emphasize checklist compliance)
2. âœ… Drafted Crucible knowledge base article (ESM publishing gotchas)
3. ðŸ“‹ Consider programmatic checklist enforcement (pre-tag hook)
4. ðŸ“‹ Update sfetch installer with GITHUB_TOKEN support
5. ðŸ“‹ Automate GitHub release creation (planned for v0.2.7)

## Lessons Learned

1. **Checklists work when followed** - v0.2.6 succeeded because we followed every step
2. **Local verification is critical** - `verify-local-install` catches production-only bugs
3. **CI can't prevent bad tags** - CI runs after tagging, too late to prevent
4. **Version numbers are permanent** - npm doesn't allow republishing
5. **Process discipline > tooling** - Best tools don't help if steps are skipped

## Related Documents

- RELEASE_CHECKLIST.md - Full release checklist
- docs/publishing.md - Detailed publishing guide (updated with warnings)
- docs/releases/v0.2.6.md - Release notes
- .plans/crucible/20260203/role-prompts-release-checklist.md - Proposed role updates
- .plans/crucible/20260203/kb-library-publishing-esm.md - Knowledge base article

## Metrics

- **MTTR**: ~5 hours (detection to v0.2.6 published)
- **User Impact**: Minimal (v0.2.5 fresh release, no known installs)
- **Version Numbers Burned**: 1 (v0.2.5)
- **Emergency Releases**: 1 (v0.2.6)

---

**Prepared by**: Claude Sonnet 4.5 (releng role)  
**Reviewed by**: @3leapsdave
